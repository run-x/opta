backends:
  aws:
    terraform:
      backend:
        s3:
          bucket: "{state_storage}"
          key: "{layer_name}"
          dynamodb_table: "{state_storage}"
          region: "{provider[region]}"
macros:
  _init:
    blocks:
      - backend: disabled
        modules:
          - aws-state-init:
              type: aws-state-init
              bucket_name: "{state_storage}"
              dynamodb_lock_table_name: "{state_storage}"
      - backend: enabled
        modules:
          - aws-network-init:
              type: aws-network-init
              total_ipv4_cidr_block: "10.0.0.0/16"
              public_ipv4_cidr_blocks:
                - "10.0.0.0/21"
                - "10.0.8.0/21"
                - "10.0.16.0/21"
              private_ipv4_cidr_blocks:
                - "10.0.128.0/21"
                - "10.0.136.0/21"
                - "10.0.144.0/21"
              subnet_tags:
                "kubernetes.io/cluster/main": "shared"
          - aws-eks-init:
              type: aws-eks-init
              cluster_name: main
              subnet_ids: "${{module.aws-network-init.private_subnet_ids}}"
              key_arn: "${{module.aws-state-init.kms_account_key_arn}}"
      - modules:
          - aws-eks-nodegroup:
              type: aws-eks-nodegroup
              cluster_name: "${{module.aws-eks-init.k8s_cluster_name}}"
              node_group_name: default
      - modules:
          - istio-init:
              type: istio-init
          - k8s-metric-server:
              type: k8s-metric-server
          - k8s-cluster-autoscaler:
              type: k8s-cluster-autoscaler
              cluster_name: "${{module.aws-eks-init.k8s_cluster_name}}"
              openid_provider_url: "${{module.aws-eks-init.k8s_openid_provider_url}}"
              openid_provider_arn: "${{module.aws-eks-init.k8s_openid_provider_arn}}"
modules:
  aws-state-init:
    location: git@github.com:run-x/runxc-tf-modules.git//aws-state-init
    variables:
      bucket_name: str
      dynamodb_lock_table_name: str
    outputs:
      state_bucket_id:
        export: true
      state_bucket_arn:
        export: true
      kms_account_key_arn:
        export: true
      kms_account_key_id:
        export: true
    providers:
      data:
        aws_caller_identity:
          provider: {}
        aws_region:
          provider: {}
  aws-network-init:
    location: git@github.com:run-x/runxc-tf-modules.git//aws-network-init
    variables:
      name: str
      total_ipv4_cidr_block: optional
      private_ipv4_cidr_blocks: optional
      public_ipv4_cidr_blocks: optional
      subnet_tags: optional
    outputs:
      vpc_id:
        export: true
      private_subnet_ids:
        export: true
      public_subnets_ids:
        export: true
  aws-eks-init:
    location: git@github.com:run-x/runxc-tf-modules.git//aws-eks-init
    variables:
      cluster_name: str
      k8s_version: optional
      subnet_ids: list
      key_arn: str
      control_plane_security_groups: optional
    outputs:
      k8s_endpoint:
        export: true
      k8s_ca_data:
        export: true
      k8s_cluster_auth_token:
        export: true
      k8s_cluster_name:
        export: true
      k8s_openid_provider_url:
        export: true
      k8s_openid_provider_arn:
        export: true
      k8s_node_group_security_id:
        export: true
    providers:
      provider:
        helm:
          kubernetes:
            host: "${{{module_source}.k8s_endpoint}}"
            token: "${{{module_source}.k8s_cluster_auth_token}}"
            cluster_ca_certificate: "${{base64decode({module_source}.k8s_ca_data)}}"
  istio-init:
    location: git@github.com:run-x/runxc-tf-modules.git//istio-init
    variables: {}
    outputs: {}
  aws-eks-nodegroup:
    location: git@github.com:run-x/runxc-tf-modules.git//aws-eks-nodegroup
    variables:
      cluster_name: str
      node_group_name: str
      disk_sizet: optional
      instance_type: optional
      use_gpu: optional
      node_labels: optional
      max_size: optional
      min_size: optional
      desired_size: optional
      ssh_key: optional
      ssh_security_group_ids: optional
  k8s-service:
    location: git@github.com:run-x/runxc-tf-modules.git//k8s-service
    variables:
      name: str
      namespace: optional
      target_port: optional
      replicas: optional
      image: optional
      tag: optional
      env_vars: optional
      autoscaling_cpu_percentage_threshold: optional
      autoscaling_mem_percentage_threshold: optional
      liveness_probe_path: optional
      readiness_probe_path: optional
      pod_resource_limits: optional
      pod_resource_requests: optional
  gcp-postgres: 
    location: git@github.com:run-x/runxc-tf-modules.git//gcp-postgres
    variables:
      name: str
      tier: str
      gcp-network: str
    outputs:
      db_user: str
      db_password: str
      db_host: str
      db_name: str
  k8s-secret:
    location: git@github.com:run-x/runxc-tf-modules.git//k8s-secret
    variables:
      name: str
    outputs:
      value: str
  k8s-metric-server:
    location: /Users/juandiegopalomino/runx/runxc-tf-modules/k8s-metric-server
    variables: {}
    outputs: {}
  k8s-cluster-autoscaler:
    location: /Users/juandiegopalomino/runx/runxc-tf-modules/k8s-cluster-autoscaler
    variables:
      cluster_name: str
      openid_provider_url: str
      openid_provider_arn: str
    outputs: {}
