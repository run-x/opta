backends:
  google: 
    terraform:
      backend: 
        gcs:
          bucket: "{state_storage}"
          prefix: "{layer_name}"
macros:
  _init:
    blocks:
      - backend: disabled
        modules:
          - state-init:
              type: state-init
              bucket_name: "{state_storage}"
      - backend: enabled
        modules:
          - compute-init:
              type: compute-init
          - k8s-node-pool:
              type: k8s-node-pool
              k8s-cluster-name: "${{module.compute-init.k8s-cluster-name}}"
modules:
  state-init:
    location: git@github.com:run-x/runxc-tf-modules.git//state-init
    variables:
      bucket_name: str
    outputs:
      state-bucket-name:
        export: true
    providers:
      data:
        google_client_config:
          provider: {}
  compute-init:
    location: git@github.com:run-x/runxc-tf-modules.git//compute-init
    variables:
      name: str
    outputs:
      gcp-network:
        export: true
      k8s-cluster:
        export: true
      k8s-cluster-name:
        export: true
    providers:
      provider:
        helm:
          kubernetes:
            host: "https://${{{module_source}.k8s-cluster.endpoint}}"
            token: "${{data.google_client_config.provider.access_token}}"
            cluster_ca_certificate: "${{base64decode({module_source}.k8s-cluster.master_auth[0].cluster_ca_certificate)}}"
  k8s-node-pool:
    location: git@github.com:run-x/runxc-tf-modules.git//k8s-node-pool
    variables:
      node-pool-name: optional
      machine-type: optional
      max-node-count: optional
      min-node-count: optional
      k8s-cluster-name: str
  k8s-service:
    location: git@github.com:run-x/runxc-tf-modules.git//k8s-service
    variables:
      name: str
      namespace: optional
      target_port: optional
      replicas: optional
      image: optional
      tag: optional
      env_vars: optional
      autoscaling_cpu_percentage_threshold: optional
      autoscaling_mem_percentage_threshold: optional
      liveness_probe_path: optional
      readiness_probe_path: optional
      pod_resource_limits: optional
      pod_resource_requests: optional
  gcp-postgres: 
    location: git@github.com:run-x/runxc-tf-modules.git//gcp-postgres
    variables:
      name: str
      tier: str
      gcp-network: str
    outputs:
      db_user: str
      db_password: str
      db_host: str
      db_name: str
  k8s-secret:
    location: git@github.com:run-x/runxc-tf-modules.git//k8s-secret
    variables:
      name: str
    outputs:
      value: str
